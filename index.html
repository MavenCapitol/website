<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Maven Capitol Consulting - Maryland Legislative Intelligence</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Mirador&display=swap" rel="stylesheet">

  <!-- Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- D3 (for bubble chart) -->
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #F5F5F5;
      color: #000;
      line-height: 1.6;
    }

    /* Loading Section */
    .loading-section {
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #F5F5F5;
      overflow: hidden;
    }

    .background-video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }

    .logo-container {
      z-index: 1;
      margin-bottom: 2rem;
    }

    .logo-container img {
      max-width: 380px;
    }

    .loading-text {
      z-index: 1;
      font-family: 'Mirador', serif;
      font-size: 2.4rem;
      letter-spacing: 0.15em;
      color: #F5F5F5;
    }

    nav {
      background: #F5F5F5;
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    nav .container {
      max-width: 1200px;
      margin: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 2rem;
    }

    nav a {
      color: #000;
      text-decoration: none;
    }

    .hero, .what-we-do, .countdown-section, .why-maven {
      padding: 4rem 2rem;
    }

    .container {
      max-width: 1200px;
      margin: auto;
    }

    .map-container {
      max-width: 900px;
      margin: 2rem auto;
      border-radius: 15px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(0,0,0,0.05);
    }

    #viewDiv {
      width: 100%;
      height: 500px;
    }

    footer {
      padding: 2rem;
      text-align: center;
      background: #F5F5F5;
    }

    .leaflet-container {
      background: #F5F5F5;
    }

    /* ===== Bubble chart ===== */
    .bubble-wrap{
      max-width: 1000px;
      margin: 2rem auto 0 auto;
      border-radius: 15px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(0,0,0,0.03);
      padding: 1rem;
    }

    #bubbleChart{
      width: 100%;
      height: 560px;
    }

    .bubble-tooltip{
      position: absolute;
      pointer-events: none;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.15);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
      font-size: 0.95rem;
      line-height: 1.2;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 120ms ease, transform 120ms ease;
    }
  </style>
</head>

<body>

<!-- Loading -->
<section class="loading-section">
  <video class="background-video" autoplay muted loop playsinline>
    <source src="https://storage.googleapis.com/mavencapitolwebsiteimages/maven-video.mp4" type="video/mp4">
  </video>

  <div class="logo-container">
    <img src="maven-logo.png" alt="Maven Capitol Consulting Logo">
  </div>

  <div class="loading-text">MAVEN CAPITOL CONSULTING</div>
</section>

<!-- Navigation -->
<nav>
  <div class="container">
    <strong>Maven Capitol Consulting</strong>
    <ul>
      <li><a href="#what">What We Do</a></li>
      <li><a href="#topics">Topics</a></li>
      <li><a href="#map">Session Tracker</a></li>
      <li><a href="#maven">Why Maven</a></li>
    </ul>
  </div>
</nav>

<!-- What We Do -->
<section class="what-we-do" id="what">
  <div class="container">
    <h2>What We Do</h2>
    <p>
      Advanced legislative intelligence for Maryland businesses using
      machine-learning driven analysis and expert consulting.
    </p>
  </div>
</section>

<!-- Topics Section (Bubble Chart) -->
<section class="countdown-section" id="topics">
  <div class="container">
    <h2>Most Common MGA Topics (2024 Session)</h2>
    <p style="margin-top:0.5rem; opacity:0.8;">
      Bubble size reflects the number of bills corresponding to the <strong>primary MGA topic</strong>.
      Hover to view topic labels.
    </p>

    <div class="bubble-wrap">
      <div id="bubbleChart"></div>
    </div>
  </div>
</section>

<!-- Map Section -->
<section class="countdown-section" id="map">
  <div class="container">
    <h2>Maryland General Assembly Coverage</h2>

    <div class="map-container">
      <div id="viewDiv"></div>
    </div>

    <p style="margin-top:1rem; opacity:0.8;">
      Last updated: <span id="lastUpdated">—</span>
    </p>
  </div>
</section>

<!-- Why Maven -->
<section class="why-maven" id="maven">
  <div class="container">
    <h2>Why Maven Capitol Consulting?</h2>
    <p>Precision, speed, and legislative expertise.</p>
  </div>
</section>

<!-- Footer -->
<footer>
  <p>&copy; 2026 Maven Capitol Consulting LLC. All rights reserved.</p>
</footer>

<!-- =========================
     MAP + BUBBLES INITIALIZATION
     ========================= -->
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      /* =========================
         MAP INITIALIZATION
         ========================= */

      const map = L.map("viewDiv", {
        scrollWheelZoom: false,
        attributionControl: false
      }).setView([39.0, -76.8], 8);

      L.control.attribution({
        prefix: 'Leaflet'
      }).addTo(map);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: 'MD iMAP | State of Maryland',
        maxZoom: 19
      }).addTo(map);

      const response = await fetch("mdMap.json");
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const geojson = await response.json();

      const layer = L.geoJSON(geojson, {
        style: {
          color: "#000",
          weight: 1.5,
          fillOpacity: 0,
          fillColor: "transparent"
        },
        onEachFeature: (feature, lyr) => {
          const name =
            feature?.properties?.COUNTY ||
            feature?.properties?.NAME ||
            feature?.properties?.name ||
            "County";

          lyr.bindTooltip(name, { sticky: true });

          lyr.on("mouseover", function () {
            this.setStyle({
              fillOpacity: 0.3,
              fillColor: "#ffffff"
            });
          });

          lyr.on("mouseout", function () {
            this.setStyle({
              fillOpacity: 0,
              fillColor: "transparent"
            });
          });
        }
      }).addTo(map);

      L.geoJSON({
        type: "Feature",
        geometry: {
          type: "Polygon",
          coordinates: [[
            [-180, -90],
            [-180, 90],
            [180, 90],
            [180, -90],
            [-180, -90]
          ]]
        }
      }, {
        style: {
          color: "transparent",
          fillColor: "#808080",
          fillOpacity: 0.5,
          weight: 0
        },
        interactive: false
      }).addTo(map);

      layer.bringToFront();
      map.fitBounds(layer.getBounds(), { padding: [20, 20] });

      document.getElementById("lastUpdated").textContent =
        new Date().toLocaleString();

      /* =========================
         BUBBLE CHART (MGA TOPICS)
         ========================= */

      // Tooltip (one per page). Remove any existing tooltip to avoid duplicates on hot reload.
      d3.selectAll(".bubble-tooltip").remove();
      const tooltip = d3.select("body")
        .append("div")
        .attr("class", "bubble-tooltip");

      // Load CSV (must be hosted in same repo)
      const rows = await d3.csv("MD_2024_MavenULTRA.csv", d => ({
        bill_id: d.bill_id,
        state: (d.state || "").trim(),
        year: +d.year,
        mga_topic: (d.mga_topic || "").trim()
      }));

      const md2024 = rows.filter(r =>
        r.state === "MD" && r.year === 2024 && r.mga_topic
      );

      // First MGA topic (before the first semicolon)
      const firstTopic = (s) => {
        const t = (s || "").split(";")[0].trim();
        return t.length ? t : "Unknown";
      };

      // Count frequencies
      const counts = d3.rollup(
        md2024,
        v => v.length,
        r => firstTopic(r.mga_topic)
      );

      // Convert to array, sort, and take top N
      const data = Array.from(counts, ([topic, value]) => ({ topic, value }))
        .sort((a, b) => d3.descending(b.value, a.value))
        .slice(0, 35);

      const container = document.getElementById("bubbleChart");
      const width = container.clientWidth || 900;
      const height = container.clientHeight || 560;

      // Clear if re-rendering
      d3.select("#bubbleChart").selectAll("*").remove();

      const svg = d3.select("#bubbleChart")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("width", "100%")
        .attr("height", "100%");

      const root = d3.hierarchy({ children: data })
        .sum(d => d.value);

      const pack = d3.pack()
        .size([width, height])
        .padding(6);

      const nodes = pack(root).leaves();

      // ---- IMPORTANT COLOR FIX ----
      // Your circles looked gray because either:
      // (a) an overriding CSS/opacity was washing them out, or
      // (b) some topics weren't getting mapped (falling back to default styling).
      // This guarantees a vivid color for EVERY topic and full visibility.

      // Bright, vivid palette (high-chroma)
      const palette = [
        "#ff3b30", "#ff9500", "#ffcc00", "#34c759",
        "#00c7be", "#007aff", "#5856d6", "#af52de",
        "#ff2d55", "#a2845e", "#64d2ff", "#30d158",
        "#ffd60a", "#ff6b6b", "#4dd0e1", "#5e5ce6",
        "#bf5af2", "#ff9f0a", "#32d74b", "#0a84ff",
        "#ff375f", "#8e8e93", "#00bcd4", "#9c27b0"
      ];

      // Stable mapping: topic -> palette index (no missing colors)
      const colorScale = d3.scaleOrdinal()
        .domain(data.map(d => d.topic))
        .range(palette);

      // Group container
      const g = svg.append("g");

      const node = g.selectAll("g")
        .data(nodes)
        .enter()
        .append("g")
        .attr("transform", d => `translate(${d.x},${d.y})`);

      node.append("circle")
        .attr("r", d => d.r)
        .attr("fill", d => colorScale(d.data.topic))
        .attr("fill-opacity", 0.95)                 // make sure color is vivid
        .attr("stroke", "rgba(255,255,255,0.95)")   // crisp separation
        .attr("stroke-width", 2)
        .style("filter", "drop-shadow(0px 8px 18px rgba(0,0,0,0.20))")
        .on("mousemove", (event, d) => {
          tooltip
            .style("left", (event.pageX + 12) + "px")
            .style("top", (event.pageY - 20) + "px")
            .style("opacity", 1)
            .style("transform", "translateY(0px)")
            .html(`<strong>${d.data.topic}</strong><br/>Bills: ${d.data.value}`);
        })
        .on("mouseout", () => {
          tooltip
            .style("opacity", 0)
            .style("transform", "translateY(6px)");
        });

      // Labels (only for larger bubbles)
      node.append("text")
        .attr("text-anchor", "middle")
        .style("font-family", "Segoe UI, Tahoma, Geneva, Verdana, sans-serif")
        .style("font-weight", "600")
        .style("fill", "rgba(0,0,0,0.85)")
        .style("paint-order", "stroke")
        .style("stroke", "rgba(255,255,255,0.85)")
        .style("stroke-width", "3px")
        .style("font-size", d => `${Math.max(10, Math.min(16, d.r / 3))}px`)
        .style("opacity", d => (d.r > 34 ? 0.95 : 0))
        .text(d => {
          const s = d.data.topic;
          return s.length > 28 ? s.slice(0, 28) + "…" : s;
        });

    } catch (error) {
      console.error("Initialization error:", error);
      document.getElementById("viewDiv").innerHTML =
        '<div style="padding:2rem;text-align:center;">Error: ' +
        error.message +
        '</div>';
    }
  });
</script>

</body>
</html>
